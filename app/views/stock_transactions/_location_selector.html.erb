<%# Cache locations to avoid repeated queries %>
<% locations = team.locations.ordered.to_a %>
<% locations_count = locations.size %>

<%# Fragment cache for location selector based on team locations and config type %>
<% cache [team, locations.map(&:updated_at).max, config.type, 'location_selector'] do %>
<div class="p-6 border-b border-gray-200">
  <% if config.requires_both_locations? %>
    <!-- Dual Location Mode (for move transactions) -->
    <div class="grid grid-cols-2 gap-6">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          <%= t("stock_transactions.#{config.type}.from_location") %><span class="text-red-500">*</span>
        </label>
        <% if locations_count >= 2 %>
          <select name="source_location_id" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-purple-500 focus:border-purple-500">
            <% locations.each_with_index do |location, index| %>
              <option value="<%= location.id %>" <%= 'selected' if index == 0 %>>
                <%= location.name %>
              </option>
            <% end %>
          </select>
        <% else %>
          <%= render 'stock_transactions/location_error', 
                     message: t('stock_transactions.errors.insufficient_locations_for_move'),
                     action_text: t('stock_transactions.errors.create_location'),
                     action_path: new_team_location_path(team) %>
        <% end %>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          <%= t("stock_transactions.#{config.type}.to_location") %><span class="text-red-500">*</span>
        </label>
        <% if locations_count >= 2 %>
          <select name="destination_location_id" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-purple-500 focus:border-purple-500">
            <% locations.each_with_index do |location, index| %>
              <option value="<%= location.id %>" <%= 'selected' if index == 1 %>>
                <%= location.name %>
              </option>
            <% end %>
          </select>
        <% else %>
          <%= render 'stock_transactions/location_error', 
                     message: t('stock_transactions.errors.insufficient_locations_for_move'),
                     action_text: t('stock_transactions.errors.create_location'),
                     action_path: new_team_location_path(team) %>
        <% end %>
      </div>
    </div>
  <% else %>
    <!-- Single Location Mode (for stock_in, stock_out, adjust) -->
    <div class="grid grid-cols-1 gap-6">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          <%= t("stock_transactions.#{config.type}.location") %><span class="text-red-500">*</span>
        </label>
        <% if locations_count > 0 %>
          <% location_field_name = config.requires_source_location? ? 'source_location_id' : 'destination_location_id' %>
          <select name="<%= location_field_name %>" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-purple-500 focus:border-purple-500">
            <% locations.each_with_index do |location, index| %>
              <option value="<%= location.id %>" <%= 'selected' if index == 0 %>>
                <%= location.name %>
              </option>
            <% end %>
          </select>
        <% else %>
          <%= render 'stock_transactions/location_error', 
                     message: t('stock_transactions.errors.no_locations'),
                     action_text: t('stock_transactions.errors.create_location'),
                     action_path: new_team_location_path(team) %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
<% end %>